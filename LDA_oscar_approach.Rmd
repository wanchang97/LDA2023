---
title: "LDA - Delivery"
author: "Oscar Cabanelas"
date: '2023-03-23'
output: pdf_document
---
- Data description (using plots and so on)
- Summary statistics (summary and so on)
- Fit multivariate model
- Two stage analysis
- random effect model (from wang)

```{r}
#install.packages("pacman")
library(pacman)
p_load(readxl, magrittr, dplyr, lattice, ggplot2, nlme)
```



# Theory of Linear Mixed Effects Model(LMM)
## Index description
Let us assume that a given input data set $X$ has a dimension $N \times p$, with $N$ observations and $p$ predictors.

For each subject indexed with $i, i = 1,\cdots,I$, we can build a linear mixed effect model 

$$\bf{Y}_i = \bf{X}_i \bf{\beta} + \bf{Z}_i \bf{b}_i + \bf{\epsilon}_i$$

## The application of LMM 
Linear Mixed Effects Model is used to analyse a data set, where the observations are not fully independent, while the top level clusters are assumed independent. Inside each cluster, the observations are correlated 

## Introduction

The dataset contains information on patients who received a renal graft (kidney transplant).

The patients have been followed for at most 10 years.

The variables included in the analysis are: 
ID: identification number
MALE: 0=female, 1=male
AGE: Age at transplantation
CARDIO: has the patient experienced a cardio-vascular problem during the years preceding the transplantation? 0=no, 1=yes
REJECT: has the patient shown symptoms of graft rejection during the first three months after the transplantation? 0=no, 1=yes
Hc0: Haematocrit level at the moment of transplantation
Hc06: Haematocrit level 6 months after transplantation
Hc1, Hc2, ..., HC10: Haematocrit level 1 year, 2 years, ..., 10 years after transplantation

## Data description

First of all, we load the data that will be used for the analysis. 

```{r message=FALSE, warning=FALSE}
library(readxl)
trenal <- read_excel("Trenal.XLS")
head(trenal)
```

```{r message=FALSE, warning=FALSE}
dim(trenal)
```

As we can see, the dataset is composed of 13920 rows and 20 columns. 

```{r message=FALSE, warning=FALSE}
trenal= trenal[,-18]
summary(trenal)
```

From the 1st column to the 12th, the values appear to be the levels of Haematocrit at each period, information that appears also with the combination of variables time and response. So, we decide to use only the information from the 13th column on in order not to overlap information and use the **long format** of it. 

```{r message=FALSE, warning=FALSE}
trenal.long = trenal[,13:20]
summary(trenal.long)
```
Now, it is interesting to relocate the variables in order to have a clear format . Moreover, some of the variables are transformed to factor since they are not numerical ones. 

```{r message=FALSE, warning=FALSE}
trenal.long$id = as.factor(trenal.long$id)
trenal.long$j = as.factor(trenal.long$j)
trenal.long$male = as.factor(trenal.long$male)
trenal.long$cardio = as.factor(trenal.long$cardio)
trenal.long$reject = as.factor(trenal.long$reject)

data <- trenal.long %>%
relocate(id) %>%
relocate(j,.after=id)%>%
relocate(time,.after = j)%>%
relocate(respons,.after=time)
summary(data)
```

#Check NA's from wanchang

Now, we can plot the data. To do that, we are going to create a spaguetti plot. 

```{r}
Plot1<-xyplot(respons ~ time, groups = id,
              data = trenal.long,
              type = "l" ,xlab="Years after transplation",ylab="Levels of Haematocrit after transplation")
#add title
```



**Comment**:

As we can see, there is a lot of variability in the origin, since the values go from 20 until 50 approximately. Furthermore, in this plot we can not see a clear difference in the slopes. Since that, we are going to pick up a random sample for trying to understand that aspect. 

To do that, we are going to use the ggplot function to make it beauty.

```{r}
set.seed(1)
selected <- sample(1:length(unique(trenal.long$id)),100,replace=T)
data.selected = trenal.long[(trenal.long$id %in% c(selected)), ]
```

Plot again

```{r}
(Plot2<-xyplot(respons ~ time, groups = id,
              data = data.selected,
              type = "l" ,xlab="Years after transplation",ylab="Levels of Haematocrit after transplation"))
```

```{r}
ggplot(data.selected,aes(x=time,y=respons,group=id,color=id))+geom_point()+ geom_line()+theme_light()+ theme(legend.position = "none")
```

After choosing a random sample, we can see that the first year after the treatment there is a peak in the level of Haematocrtit and, afterwards, it seems to stabilize in each of the sample individuals regardless their initial level. 

Now, it is interesting to check if we can find differences between genders:


```{r}
ggplot(data.selected,aes(x=time,y=respons,group=id,color=male))+geom_point()+ geom_line()+theme_light()
```

**Comment**

It seems that the Haematocrit level is higher in males than in females. However, the variability seems similar. 

```{r}
ggplot(data.selected,aes(x=male,y=respons))+geom_boxplot()+theme_light()
```

**Comment**

In the boxplot we can check that also the variability in males is higher than in females. 

Furthermore, we can check it depending on the level of cardio

```{r}
ggplot(data.selected,aes(x=time,y=respons,group=id,color=cardio))+geom_point()+ geom_line()+theme_light()
```
**Comment**

It seems that the variability of Haematocrit level is higher in people without experiencing a cardio-vascular problem during the years preceding the transplantation

```{r}
ggplot(data.selected,aes(x=cardio,y=respons))+geom_boxplot()+theme_light()
```

**Comment**

It seems that after checking the boxplot, the variability is similar in both groups indeed, same case as in the mean approach. 

```{r}
ggplot(data.selected,aes(x=time,y=respons,group=id,color=reject))+geom_point()+ geom_line()+theme_light()
```
**Comment**

It seems that the variability of Haematocrit level is higher in patient who did not show symptoms of graft rejection during the first three months after the transplantation. 

```{r}
ggplot(data.selected,aes(x=reject,y=respons))+geom_boxplot()+theme_light()
```


Add here things about the mean that Wanchang did by group.

2. Summary statistics

Analysis of endpoints: the response at the last mesure

To check this, we need to extract the last measurement for each individual. To do that, we just need to select the row in which the time is equal to 10.0. 

```{r}
last_measurement <- subset(trenal.long, trenal.long$time == 10)
summary(last_measurement)
#Check the mean and everything about last point response
```
**Comment**

The last point of the *respons* has 812 NAs from the 1154 measurements. 

```{r}
last_measurement$resp_na<-ifelse(is.na(last_measurement$respons) == T, 1, 0)

last_measurement$resp_na<- as.factor(last_measurement$resp_na)
summary(last_measurement$resp_na)

```

How it is composed for male/female?

```{r}
last_measurement_male <- last_measurement %>%                                    # Count NA by group
  group_by(male) %>%
  dplyr::summarize(count_na = sum(is.na(respons)))
last_measurement_male 
```

How is it composed for rejection or nor?

```{r}
last_measurement_reject <- last_measurement %>%                                    # Count NA by group
  group_by(reject) %>%
  dplyr::summarize(count_na = sum(is.na(respons)))
last_measurement_reject
```

How is it composed for cardio or not?

```{r}
last_measurement_cardio <- last_measurement %>%                                    # Count NA by group
  group_by(cardio) %>%
  dplyr::summarize(count_na = sum(is.na(respons)))
last_measurement_cardio
```

Analysis of increments: Difference between the response at the first available and the last one.

We will use just the non NA values

```{r}
trenal.long.incr<-trenal.long_no_na %>% 
  filter(time == c(0, 10)) %>% 
  group_by(id) %>% 
  mutate(incr = max(respons) - min (respons), one = 1) %>% 
  filter(!incr %in% 0)
```
```{r}

boxplot(trenal.long.incr$incr)

ggplot(trenal.long.incr,aes(x=one,y=respons))+geom_boxplot()+theme_light()
```

Increment

Increment per unit of time

3. Fit a multivariate model and find the most parsimonious mean structure which can be used to describe the average evolutions in the data. What covariance structures are applicable in this case? What is the most parsimonious structure you can find? 

To do that, we are going to use the lm function. We will try to create different linear models using all the available variables in the data set. 

On top of that, we want to test if the level of rejection affection in the response variable can depend on the time. Since that, we also apply one interaction between the time and the rejection level. 

```{r}
trenal.lm<-lm(respons ~ time, data = trenal.long)
trenal.lm2 <- lm(respons ~ time + male, data = trenal.long)
trenal.lm3 <- lm(respons ~ time + male + age, data = trenal.long)
trenal.lm4 <- lm(respons ~ time + male + age + reject, data = trenal.long)
trenal.lm5 <- lm(respons ~ time + male + age + cardio, data = trenal.long)
trenal.lm6 <- lm(respons ~ time + male + age + reject + cardio, data = trenal.long)
trenal.lm7 <- lm(respons ~ time + male + age + reject + reject:time, data = trenal.long)

anova(trenal.lm, trenal.lm2, trenal.lm3, trenal.lm4, trenal.lm5, trenal.lm6)
```

```{r}
anova(trenal.lm3, trenal.lm5)
```

CORR AND COVARIANCE STRUCTURE

```{r}
trenal.wide = trenal[,1:17]

dataCorr<- trenal.wide[, c(1:12)]
cor(dataCorr,use="complete.obs") #Also COV for covarianza
cov(dataCorr,use="complete.obs")
library("PerformanceAnalytics")
chart.Correlation(dataCorr , histogram=T)
```


4. Use an explicit two-stage analysis to get an initial impression about trends and effects of covariates. 


As a first step, we need to create a *groupedData* object in order to apply it to the following process. 


```{r}
trenal.long_no_na <- na.omit(trenal.long)

trenal_grouped1<-groupedData(respons~time|id,trenal.long_no_na, inner = ~ male, labels=list(y="level of Haematocrit"),units=list(y="level of Haematocrit "))

trenal_grouped2<-groupedData(respons~time|id,trenal.long_no_na, inner = ~ reject, labels=list(y="level of Haematocrit"),units=list(y="level of Haematocrit "))

trenal_grouped3<-groupedData(respons~time|id,trenal.long_no_na, inner = ~ cardio, labels=list(y="level of Haematocrit"),units=list(y="level of Haematocrit "))

#plot(trenal_grouped1, inner =  T, key = F)
#plot(trenal_grouped2, inner = T, key = F)
#plot(trenal_grouped3, inner = T, key = F)
#here, we do not declare any group, but I should group by male, reject or cardio
#outer: time dependent
#inner: not time dependent (male, )

```


first step: A model for each individual estimating the intercept and time was adjusted. It is not significant which of the three previous models we will use, since the info is the same. 

```{r}

#REMOVE MISSINGS HERE

modlist1 <- lmList (respons ~ time, trenal_grouped1 , na.action = na.pass)


#plot(intervals(modlist1))
#plot(trenal_grouped)
```


**Comment** In here, he have the model with a beta for each individual. 

Then, we can extract all the beta0 and beta1 obtained from the model. This will be used in the following steps


```{r}
#attributes(modlist1)


beta0<- coef(modlist1)[,1]

beta1<- coef(modlist1)[,2]

```

The coefficients can be extracted by using the following function

```{r}
coef(modlist1)

```

Then, we create a data frame in which we store all the betas obtained. This will be useful for trying to split up the analysis by groups. 

```{r}

bbdd<-data.frame(id=as.numeric(attributes(modlist1)$names),
                 beta0=coef(modlist1)[,1],beta1=coef(modlist1)[,2])
bbdd <- merge(trenal.long, bbdd[,c("id","beta0", "beta1")], by.x = "id", all.x = T)

bbdd <- bbdd[order(bbdd[,1]),]

```

BETAS ANALYSIS

```{r}

ggplot(bbdd, aes(x=beta0, y=beta1)) + geom_point()

```



Here, we calculate the mean beta by groups, to check if we have significant differences. 

```{r}

(meanbeta0bymale<-tapply(bbdd$beta0,as.factor(bbdd$male),mean,na.rm=T))
(meanbeta1bymale<-tapply(bbdd$beta1,as.factor(bbdd$male),mean,na.rm=T))

```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=male)) +
geom_point()+
  geom_smooth(method='lm', formula= y~x)

```


**Comment**

It seems that for gender classification, the intercept is higher for male and also the slope.

```{r}
(meanbeta0byreject<-tapply(bbdd$beta0,as.factor(bbdd$reject),mean,na.rm=T))
(meanbeta1byreject<-tapply(bbdd$beta1,as.factor(bbdd$reject),mean,na.rm=T))
```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=reject)) + geom_point()+
  geom_smooth(method='lm', formula= y~x)

``` 

**Comment**

It seems that for rejection level classification, the intercept is higher for people without experiencing a cardio-vascular problem during the years preceding the transplantation. However, in this case the slope is higher to its opposite group. 


```{r}

(meanbeta0bycardio<-tapply(bbdd$beta0,as.factor(bbdd$cardio),mean,na.rm=T))
(meanbeta1bycardio<-tapply(bbdd$beta1,as.factor(bbdd$cardio),mean,na.rm=T))

```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=cardio)) + geom_point()+
  geom_smooth(method='lm', formula= y~x)

```

**Comment**

It seems that for gender classification, the intercept and the slope is higher for patient who did show symptoms of graft rejection during the first three months after the transplantation 


```{r}
#Let's check if they are quite related ?inverse correlation?

with(bbdd,cor(beta0,beta1))

```







Correlations (maybe not needed)

```{r}


#install.packages('dplyr', repos = 'https://cloud.r-project.org')

library(dplyr)
bbdd %>%
  group_by(male) %>%
  summarize(cor=cor(beta0, beta1))

bbdd %>%
  group_by(cardio) %>%
  summarize(cor=cor(beta0, beta1))

bbdd %>%
  group_by(reject) %>%
  summarize(cor=cor(beta0, beta1))

```

2nd step: Fit the model and confidence interval

```{r}

# Fit a model for the intercept
modbeta0<-lm(beta0~male+cardio,bbdd)
summary(modbeta0)
confint(modbeta0)

### Fit a model for the slope
# All the variables should be included
modbeta1<-lm(beta1~male+cardio,bbdd)
summary(modbeta1)
confint(modbeta1)


```

6. Pay attention to the missing, especially the ones presented by the outcome variable. Do your results still hold despite the missingness?


Outcome analysis

```{r}

summary(trenal.long$respons)

```

From the 13920 measurements, 4362 are NA's. That represents a 31% of the response measurements are NAs. 

How are they distributed?

Male

```{r}
trenal.long.na<-trenal.long %>% 
  filter(is.na(respons) == T)

trenal_na_male <- aggregate(trenal.long.na$respons, by=list(trenal.long.na$male), FUN=length)
trenal_na_male
```

```{r}
ggplot(data=trenal_na_male, aes(x=Group.1, y=x, color = Group.1)) +
  geom_bar(stat="identity")+
  ggtitle("Outcome distribution by gender")

```

**Comment**

It seems that the most part of the NAs in gender are found in males. 

Reject

```{r}

trenal_na_reject <- aggregate(trenal.long.na$respons, by=list(trenal.long.na$reject), FUN=length)
trenal_na_reject

```

```{r}
ggplot(data=trenal_na_reject, aes(x=Group.1, y=x, color = Group.1)) +
  geom_bar(stat="identity")+
  ggtitle("Outcome distribution by rejection level")

```

**Comment**

It seems that the most part of the NAs in cardio are found in the ones without experiencing a cardio-vascular problem during the years preceding the transplantation.


Cardio

```{r}

trenal_na_cardio <- aggregate(trenal.long.na$respons, by=list(trenal.long.na$cardio), FUN=length)
trenal_na_cardio

```

```{r}
ggplot(data=trenal_na_cardio, aes(x=Group.1, y=x, color = Group.1)) +
  geom_bar(stat="identity")+
  ggtitle("Outcome distribution by cardio level")

```

**Comment**

It seems that the most part of the NAs in cardio are found in the patient who did not show symptoms of graft rejection during the first three months after the transplantation. 


