---
title: "Longitudinal Data Analysis "
subtitle: "Case study of Trenal.XLS using Linear Mixed Effect Model"
author: "Group2: Wanchang Zhang; Hugo Blain; Oscar Cabanelas"
date: "`r Sys.Date()`"
output: 
  pdf_document:
  fig_caption: true
  number_sections: yes
  extra_dependencies:
    graphicx: null
    bm: null 
    multirow: null
    multicolumn: null
    hyperref: null
    amsmath : null
          
---
\newpage 
\tableofcontents 
\listoffigures
\listoftables
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE,message=FALSE)
```


1. Describe the data, and use graphical techniques to explore the mean structure, the variance structure and the correlation structure. Summarize your conclusions. What are the implications with respect to statistical modeling? 

Conclusion:

The response variable Hematocrit
(the percentage of red cells in your blood level) varies a lot on different subjects, but generally it shows that the time when just going through the kidney transplant, the HC level is quite low around $31.86\%$, it could goes back to normal half year later and remains at the similar level for the rest of the 10 years observations.

The correlation structure
shows that HC level are more correlated to the consecutive HC levels, so we may use a autoregression correlation structure in the statistical modeling. The Correlation structure suitable could be Autoregressive, time dependent or unstructured

* Autoregressiove ($\rho$)
$$R = \begin{bmatrix}
1 & \rho & \rho^2 & \cdots & \rho^{12} \\
\rho  & 1 & \rho^2 & \cdots & \rho^{11} \\ 
\vdots & \vdots & \vdots &\ddots & \vdots\\
\rho^{12} & \rho^{11} & \rho^{10} & \cdots & 1 \end{bmatrix}$$

* Time dependent ($\rho$)
$$R = \begin{bmatrix}
1 & \rho^{t_{1,2}} & \rho^{1,3} & \cdots & \rho^{1,12} \\
\rho^{t_{2,1}}  & 1 & \rho^{t_{2,3}} & \cdots & \rho^{t_{2,11}} \\ 
\vdots & \vdots & \vdots &\ddots & \vdots\\
\rho^{t_{12,1}} & \rho^{t_{12,2}} & \rho^{t_{12,3}} & \cdots & 1 \end{bmatrix}$$

* Unstructured ($\rho_{1,2},\rho_{1,3},\cdots, \rho_{1,12}, \cdots \rho_{11,12}$ totally $\frac{(11+1)\times11}{2}=66$ parameters)
$$R = \begin{bmatrix}
1 & \rho_{1,2} & \rho_{1,3} & \cdots & \rho_{1,12} \\
\rho_{2,1}  & 1 & \rho_{2,3} & \cdots & \rho_{2,11} \\ 
\vdots & \vdots & \vdots &\ddots & \vdots\\
\rho_{12,1} & \rho_{12,2} & \rho_{12,3} & \cdots & 1 \end{bmatrix}$$

2. What summary statistics are appropriate for the analysis of these data? Why? Do they yield the same results? Summarize your conclusions. 
Summary statistics: summarize and provide information about the sample data. It tells you about the values in your data set. This includes where the mean lies and whether your data is skewed. Summary statistics have three main categories from <https://www.statisticshowto.com/summary-statistics/>
1). Measures of location(central tendency)

2). Measures of spread(range, interquartile range, quartiles, skewed, Kurtosis)

this two can be answered from the `summary(trenal.wide)`

* The input data:
  * id: totall 1160 persons
  * age to perform the operation: from $15$ to $76$ years old, average is $46.43$ years old
  * male: we observe 494 females and 666 males
  * cardio: 953 persons has experienced a cardio-vascular problem during
the years preceding the transplant, 207 did not.
  * reject: 793 patients shown symptoms of graft rejection during the first
three months after the transportation, 367 has not.

* The response variable HC level
  continous from min $14\%$ to max $65\%$. It is complex to analyse without     considering different persons with different characters. The HC level is      dependent on the meassured time, individual's age to perform the              operation,  gender, cardio history and reject history

Thus we plot separatly to see if the age, gender, cardio and reject would influence the HC level change with time.

3). Graphs/charts(Histogram, Frequency Distribution Table, Box plot, Bar chart, Scatter plot, Pie char.t)

Hypothesis from the plot: 

* male has higher HC level than female
* cardio has no significant influence on HC level
* reject or not has no significant influence on HC level
* age to perform the operation is not influential on HC level



3. Fit a multivariate model and find the most parsimonious mean structure which can be used to describe the average evolutions in the data. What covariance structures are applicable in this case? What is the most parsimonious structure you can find? 
lm1 = lm(HC ~ time,data=trenal.long)
lm2 = lm(HC ~ time+male,data=trenal.long)
lm3 = lm(HC ~ time + male + reject , data=trenal.long)
lm4 = lm(HC ~ time + male + reject+ reject:time)
lm5 = lm(HC ~ time + male + reject+ reject:time)

Covariance Structure for a linaer model??????

4. Use an explicit two-stage analysis to get an initial impression about trends and effects of covariates.

5. Formulate a plausible random-effects model. Fit your model and compare the results with those from the multivariate model. Check the appropriateness of your random-effects model. Calculate the subject-specific intercepts/slopes and compare them with the ones you obtained from a two-stages analysis. What do you conclude? 



6. Pay attention to the missing, especially the ones presented by the outcome variable. Do your results still hold despite the missingness?

```{r}
# NA related to gender?
trenal.wide.male = trenal.wide[trenal.wide$male == 1,]
trenal.long.male = trenal.long[(trenal.long$male == 1)&(trenal.long$time == 0),]

male.NA = sum(is.na(trenal.long.male$HC))
male.number = dim(trenal.wide.male)[1]

male.NA.ratio = male.NA/male.number

trenal.wide.female = trenal.wide[trenal.wide$male == 0,]
female.NA = sum(is.na(trenal.wide.female$HC))

female.number = dim(trenal.wide[trenal.wide$male== 0,])[1]
female.NA.ratio = female.NA/female.number

#boxplot(c(male.NA.ratio,female.NA.ratio),c(1,0))
```

```{r}
# NA related to cardio?
trenal.wide.cardio = trenal.wide[trenal.wide$cardio == 1,]
cardio.1.NA = sum(is.na(trenal.wide.cardio$HC))
cardio.1.number = dim(trenal.wide[trenal.wide$cardio== 1,])[1]
cardio.1.NA.ratio = cardio.1.NA/cardio.1.number

trenal.wide.cardio = trenal.wide[trenal.wide$cardio == 0,]
cardio.0.NA = sum(is.na(trenal.wide.cardio$HC))
cardio.0.number = dim(trenal.wide[trenal.wide$cardio== 0,])[1]
cardio.0.NA.ratio = cardio.0.NA/cardio.0.number

```


# Theory of Linear Mixed Effects Model(LMM)
## Index description
Let us assume that a given input data set $X$ has a dimension $N \times p$, with $N$ observations and $p$ predictors.

For each subject indexed with $i, i = 1,\cdots,I$, we can build a linear mixed effect model 

$$\bf{Y}_i = \bf{X}_i \bf{\beta} + \bf{Z}_i \bf{b}_i + \bf{\epsilon}_i$$

## The application of LMM 
Linear Mixed Effects Model is used to analyse a data set, where the observations are not fully independent, while the top level clusters are assumed independent. Inside each cluster, the observations are correlated 

# Data set `Trenal.XLS` pre-analysis
## The summary of the data set

### Import data
```{r}
library(readxl)
trenal <- read_excel("Trenal.XLS") # summary(trenal)
```


### Data Preprocessing


```{r}
trenal= trenal[,-18] #remove a noninformative column const

# Continuous or discrete variables
trenal$id = as.factor(trenal$id)
trenal$j = as.factor(trenal$j)
trenal$time = as.factor(trenal$time)
trenal$male = as.factor(trenal$male)
trenal$cardio = as.factor(trenal$cardio)
trenal$reject = as.factor(trenal$reject)
# Change the name of respons
colnames(trenal)[19] <- "HC"

trenal.long = trenal[,13:20] # long table form
# Remove j
trenal.long = trenal.long[,-6]
trenal.long.noNA <- na.omit(trenal.long)# reordered
trenal.wide = as.data.frame(subset(trenal,trenal$j=="1"))[,1:18]
summary(trenal.wide)
```


```{r}
library(magrittr) # needs to be run every time you start R and want to use %>%
library(dplyr)   

data.long <- trenal.long %>% # reordered long table 
  relocate(id) %>%
  relocate(time,.after = id)%>%
  relocate(HC,.after=time)
#summary(data.long)
sum(!is.na(data.long$HC))

data.long.noNA <- na.omit(data.long)# reordered long table without NAs
summary(data.long.noNA)
data_summary_long = data.frame(unclass(summary(data.long.noNA,maxsum=1160)),check.names=FALSE)
data.long.noNA$id[length(data.long.noNA$id)]
```

### Response variable and predictors
#### Response variable
From the `summary(data.long.noNA)`, we can read that the response variable is a continuous variable `HC`level from $(15,76)$ with Mean $38.24$. (Hematocrit is the percentage of red cells in your blood %)

We have totally $I = 1160$ ids for subjects. Ideally each id would have $12$ (start from $HC_0,HC_{0.5},HC_1,HC_2,\cdots,HC_{10}$) HC level measurement, but in really not all subjects have all of the $12$ measurements (Actually only $348$ patients all $12$ measurements). We have totally $N = 9558 = \sum_{i=1}^{I} n_i$ missing values. 

#### Predictors
The explaining variables are 

1. $X_1=time$ in year as discrete values, only changes with $j$,$j = 1,\cdots,n_i$
2. $X_2=age$ in year with 12 NAs; will only change with subject id $i$
3. $X_3 = male$ 0 = female, 1= male;will only change with subject id $i$
4. $X_4 = cardio$ 0 = no, 1= yes;will only change with subject id $i$
5. $X_5 = reject$ 0 = accept, 1= reject;will only change with subject id $i$
6. fixed intercept, continuous

In the data analysis part, we need to try out different variables accounting for fixed effects and random effects.
<!-- [Formal Data Analysis](#data-set-`trenal.xls`-analysis-with-the-linear-mixed-effects-model) -->


## Data visualization and the information from the data

### Mean Structure

```{r,fig.axis=1}
library(ggplot2)
# To view the mean structure of the HC for all individuals
ggplot(data.long.noNA,aes(x=as.factor(time),y=HC,group=id))  + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)+
  labs(title="Line plot of HC level for all individuals overtime and the mean structure")
```

### Variance Structure

```{r,fig.axis=1}
# To view to variance structure
ggplot(data.long.noNA,aes(x=as.factor(time),y=HC))+ 
  geom_boxplot(position=position_dodge(1))+
  labs(title="Box Plot of HC level for all indivuduals over time and the variance structure")
```

### Covariance Structure


```{r,fig.axis=1}
HcCorr = trenal.wide[,c(1:12)]
cor(HcCorr,use="complete.obs" ) # also COV for covariance
library("PerformanceAnalytics")
chart.Correlation(HcCorr,historgram=TRUE)
```



```{r}
dim(data.long.noNA)
```


```{r}
# since the data dimension is large 9551 x 8, we can select random 30 data to have a look 
set.seed(1)
selected <- sample(1:length(unique(data.long.noNA$id)),30,replace=T) # random samples and permutations
#selected.vector = as.vector(selected)
data.selected = data.long.noNA[(data.long.noNA$id %in% c(selected)), ] 
```

#### Spaghettic plot
```{r,fig.axis = 1}
ggplot(data.selected,aes(x=time,y=HC,group=id,color=id))+geom_point()+ geom_line()+theme_light()
```
```{r,fig.axis = 1}
ggplot(data.selected,aes(x=time,y=HC,group=id,color=age))+geom_point()+ geom_line()+theme_light()
```
```{r,fig.axis = 1}
ggplot(data.long.noNA,aes(x=time,y=HC,group=id,color=age))+geom_point()+ geom_line()+theme_light()
```
Plot Info:
The intercept may vary according to each individual
The slope is not very easy to see

```{r,fig.axis=1}
ggplot(data.selected,aes(x=time,y=HC,group=id,color=male)) +geom_point()+ geom_line()+theme_light()
```
```{r,fig.axis=1}
ggplot(data.selected,aes(x=time,y=HC,group=id,color=cardio)) +geom_point()+ geom_line()+theme_light()
```

```{r,fig.axis=1}
ggplot(data.selected,aes(x=time,y=HC,group=id,color=reject)) +geom_point()+ geom_line()+theme_light()
```

```{r}
# Spaghetti Ggplot separated by male =1
p <- ggplot(data=data.long.noNA,aes(x=time,y=HC,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
p + facet_grid(~male,labeller=label_both)

```


```{r}
# Spaghetti Ggplot separated by cardio
p <- ggplot(data=data.long.noNA,aes(x=time,y=HC,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
cardio.labs <- c("Cardio = 0","Cardio = 1")
p + facet_grid(~cardio,labeller = label_both) 
```
```{r}
# Spaghetti Ggplot separated by reject =1
p <- ggplot(data=data.long.noNA,aes(x=time,y=HC,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
p + facet_grid(~reject,labeller=label_both)

```

#### Boxplot
```{r}
# Box plot by sex
ggplot(data.long.noNA,aes(x=as.factor(time),y=HC,fill=as.factor(male)))+ 
  geom_boxplot(position=position_dodge(1))
```

```{r}
# Box plot by cardio
ggplot(data.long.noNA,aes(x=as.factor(time),y=HC,fill=as.factor(cardio)))+ 
  geom_boxplot(position=position_dodge(1))
```

```{r}
# Box plot by reject
ggplot(data.long.noNA,aes(x=as.factor(time),y=HC,fill=as.factor(reject)))+ 
  geom_boxplot(position=position_dodge(1))
```

## Data set analysis to see the age effect
```{r}
library(ggplot2)
ggplot(data=data.long.noNA,aes(y=HC,x=age))+geom_point()
```


```{r}
data.groupbyage <- data.long.noNA %>%   group_by(age) %>% summarise(avgHC=mean(HC))

ggplot(data=data.groupbyage,aes(y=avgHC,x=age))+geom_point()
```


```{r}
library(jtools)

plot(data.groupbyage,xlab="age",ylab="average HC")
#fit.age = lm(HC ~ time +age,data=data.long.noNA)
#summ(fit.age)

#fit.age = lm(HC ~ time +age,data=data.long.noNA)
#summ(fit.age)
```



# Data set `Trenal.XLS` analysis with the Multilevel models 
<!-- #[Formal Data Analysis](#Data set `Trenal.XLS` analysis with the linear mixed effects model) -->

This is inspired from the chapter of <https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html>
Longitudinal data is a special example of two-level model, where

  * Level One is : time and HC level 
  * Level Two is : covariates related to each subject, e.g. age, male, reject, cardio

We can first try the unconditional Means Model to explore the variance( within subject and between-subject), Define $Y_{ij}$ as the HC level from subject $i$ and measured time $j$

  * Level One: $$Y_{ij} = a_i + \epsilon_{ij}$$, where $\epsilon_{ij} ~ N(0,\sigma^2)$
  * Level Two: $$a_i = \alpha_0 + u_i$$, where $u_i ~ N(0,\sigma_{u}^2)$
  
Written in linear mixed effect model is:
 $$Y_{ij} = \alpha_0 + u_i + \epsilon_{ij}$$, where $u_i ~ N(0,\sigma_u^2)$ and $\epsilon_{ij} ~ N(0,\sigma^2)$
 
 
```{r}
# Model A
model.a <- lmer(HC ~ 1 + (1|id),)
```


