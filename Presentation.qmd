---
title: "Longitudinal Data Analysis "
subtitle: 'Case study of Trenal.XLS'
author: "Group2: Hugo Blain; Oscar Cabanelas;Wanchang Zhang"
date: "`r Sys.Date()`"
format:
  revealjs:
    
    scrollable: true
bibliography: "scholar.bib"
editor_options: 
  markdown: 
    wrap: 72
---

## Outline {visibility="hidden"}

```{r packages, echo=FALSE}
if (!require(mlbench)) install.packages("mlbench", dep=TRUE)
```

1.  Data description

2.  Data analysis

# Data description

```{r,echo=FALSE}
library(readxl)
library(knitr)
library(ggplot2)
library(dplyr)
library(lme4)
library(GGally)
library(nlme)
library(tidyr)
library("PerformanceAnalytics")
```

```{r}
trenal <- read_excel("Trenal.XLS") # summary(trenal)

trenal= trenal[,-18] #remove a noninformative column const

# Continuous or discrete variables
trenal$id = as.factor(trenal$id)
trenal$j = as.factor(trenal$j)
#trenal$time = as.factor(trenal$time)
trenal$male = as.factor(trenal$male)
trenal$cardio = as.factor(trenal$cardio)
trenal$reject = as.factor(trenal$reject)

# Change the name of respons
colnames(trenal)[19] <- "Hc"
trenal.long = trenal[,13:20] # long table form

# Remove j
trenal.long = trenal.long[,-6]
trenal.long.unique <- trenal.long[match( unique(trenal.long$id), trenal.long$id),]# meanHc should replace trenal.long.unique$Hc
trenal.long.noNA <- na.omit(trenal.long)

# Wide table form
trenal.wide = as.data.frame(subset(trenal,trenal$j=="1"))[,1:18] # 1160 x 18

# Center time 
trenal.long.center <- trenal.long%>%
  mutate(timec = time - 5,timec2 = timec^2)

# scale age
trenal.long.scaled <- trenal.long%>%
  mutate(agescaled = (age - 46.43 )/(76-15) )


# Modeling piecewise linear time trend with two intervals
time1 = trenal.long$time
time1[time1>0.5] = 0
time2 = trenal.long$time
time2[time2<1] = 0
  
trenal.long.piecewise = trenal.long
trenal.long.piecewise['time1'] <- time1
trenal.long.piecewise['time2'] <- time2
```

## Background

-   The dataset `Trenal.XLS` contains information on patients who
    received renal graft(kidney transplant). The patients have been
    followed for at most 10 years.

-   People with end-stage kidney disease who receive a kidney transplant
    generally live longer than people with ESRD who are on dialysis.

-   However, kidney transplant recipients must remain on
    immunosuppressants (medications to suppress the immune system) for
    the rest of their life to prevent their body from rejecting the new
    kidney. The long-term immunosuppression puts them at risk for
    infections and cancer.

-   Haematocrit level is meassured for each patient who has received
    renal graft to see if gender, the age to go through the operation,
    reject or not, cardio history or not will influence the healthy
    state of a patient after operation.

## Data organisation {.smaller}

| **Variables**                      | **Physical Meaning**                                                                                        | **Types of the variable**                                             |
| id                                 | Identification Number of each subject                                                                       | Categorical, ordinal $1,2,3,\cdots,1160$                              |
| Hc                                 | Haematocrit level (the percentage of red blood cells in the body)                                           | Continuous units in $\%$                                              |
| Hc0, Hc06, Hc1, Hc2,$\cdots$, Hc10 | Haematocrit level meassured at the moment of time ${0,0.5,1,2,\cdots,10}$ years after the kidney transplant | Continuous; units in $\%$                                             |
| age                                | Age of the patient when performing the kidney transplant                                                    | Continuous; from $15$ to $76$ years old, average is $46.43$ years old |
| male                               | Gender                                                                                                      | Binary: 0 = female ; 1 = male                                         |
| reject                             | Has the patient shown symptoms of graft rejection during the first three months after the transportation    | Binary: 0 = no 1 = yes                                                |
| cardio                             | Has the patient experienced a cardio-vascular problem during the years preceding the transplantation        | Binary: 0 = no 1 = yes                                                |

## Observations

Our given data set is Longitudinal data with two levels: time-level and
subject-level

-   *Time-level* (also called *first level*) variables: changed with
    time, indexed by $j$ e.g. time and response Hc
-   *Subject-level* (also called *second level*) variables: changed with
    subjects indexed by $i$ e.g. age, male, reject, cardio

>>>>>>> 60a6cf47364d2a008e1b4a19dadb594f05202b2b
## Missing data distribution

```{r,echo=FALSE,fig.axis=1,fig.align='center'}
# Analyse the NA values descriptively
## First to collect how many NAs are in Hc0, Hc0.5, Hc1, ..., Hc 10
Hc.NA = numeric(12)
for (i in c(1:12)) {
  Hc.NA[i] = sum(is.na(trenal.wide[,i]))
}
# 1   0   1  87 205 314 418 508 595 672 749 812
# The number of missing data / the ideal case have all measurements for everyone
Hc.NA.percentage = Hc.NA/dim(trenal.long.unique)[1]
missing <- data.frame(rbind(Hc.NA,Hc.NA.percentage))
kable(missing, caption= "Missing data for each measurement",
      col.names =colnames(trenal.wide[c(1:12)]),digits = 3)
plot(Hc.NA.percentage,xaxt="n",xlab ="j",ylab="Missing data%")
axis(side=1,at=c(1,2,3,4,5,6,7,8,9,10,11,12),labels=colnames(trenal.wide)[1:12])

```

## Missing data distribution {.smaller}

::: columns
::: {.column width="40%"}
-   First we extract a data with the Hc level is missing (shown as NA)
    as a new data frame `trenal.long.NA.unique`
-   Then We plot the histogram of all the predictors: age, male, cardio
    and reject (the 4 columns corresponding to the right figure).on both
    the original data set `trenal.long.unique` and the missing data
    frame `trenal.long.NA.unique`
-   We may conclude that missing data are random and has no specific
    preference on any type of the person.
:::

::: {.column width="58%"}
```{r fig.align='center', out.width="100%"}
knitr::include_graphics("images/MissingValueAnalysis.png")
```
:::
:::

# Exploratory Data analysis

## Mean Structure

```{r,fig.axis=1,fig.align='center'}
# To view the mean structure of the Hc for all individuals
ggplot(trenal.long.noNA,aes(x=as.factor(time),y=Hc,group=id))  + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)+
  labs(title="Line plot of Hc level for all individuals overtime and the mean structure")
```

## Variance Structure

```{r,fig.axis=1,fig.align='center'}
# To view to variance structure
ggplot(trenal.long.noNA,aes(x=as.factor(time),y=Hc))+ 
  geom_boxplot(position=position_dodge(1))+
  labs(title="Box Plot of Hc level for all indivuduals over time and the variance structure")
```

## Covariance Structure

```{r,fig.axis=1,fig.align='center'}
HcCorr = trenal.wide[,c(1:12)]
#cor(HcCorr,use="complete.obs" ) # also COV for covariance
chart.Correlation(HcCorr,historgram=TRUE)
```

# Find out which covariate might influence the responses time trend

## Spaghetti plot

```{r,echo=FALSE}
# since the data dimension is large 9551 x 8, we can select random 30 data to have a look 
set.seed(1)
selected <- sample(1:length(unique(trenal.long.noNA$id)),30,replace=T) # random samples and permutations
#selected.vector = as.vector(selected)
data.selected = trenal.long.noNA[(trenal.long.noNA$id %in% c(selected)), ] 
```

### Spaghetti plot group by id

```{r,fig.axis = 1,echo=FALSE}
ggplot(data.selected,aes(x=time,y=Hc,group=id,color=id))+geom_point()+ geom_line()+theme_light()
```

### Spaghetti plot group by male

```{r,fig.axis=1,echo=FALSE}
p <- ggplot(data=trenal.long.noNA,aes(x=time,y=Hc,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
p + facet_grid(~male,labeller=label_both)

```

### Spaghetti plot group by cardio

```{r,echo=FALSE}
# Spaghetti Ggplot separated by cardio
p <- ggplot(data=trenal.long.noNA,aes(x=time,y=Hc,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
cardio.labs <- c("Cardio = 0","Cardio = 1")
p + facet_grid(~cardio,labeller = label_both) 
```

### Spaghetti plot group by reject

```{r, echo=FALSE}
# Spaghetti Ggplot separated by reject =1
p <- ggplot(data=trenal.long.noNA,aes(x=time,y=Hc,group=id))
p <- p + geom_line(col="grey")+stat_summary(aes(group=1),geom="line",fun=mean,linewidth=2)
p + facet_grid(~reject,labeller=label_both)

```

## Boxplot

### Box plot by male

```{r, echo=FALSE}
ggplot(trenal.long.noNA,aes(x=time,y=Hc,fill=as.factor(male)))+ 
  geom_boxplot(position=position_dodge(1))
```

### Box plot by cardio

```{r,fig.align = "center",echo=FALSE}
# Box plot by cardio
ggplot(trenal.long.noNA,aes(x=as.factor(time),y=Hc,fill=as.factor(cardio)))+ 
  geom_boxplot(position=position_dodge(1))
```

### Box plot by reject

```{r,echo=FALSE}
ggplot(trenal.long.noNA,aes(x=as.factor(time),y=Hc,fill=as.factor(reject)))+ 
  geom_boxplot(position=position_dodge(1))
```

## Data set analysis to see the age effect

```{r}
ggplot(data=trenal.long.noNA,aes(y=Hc,x=age))+geom_point()
```

```{r}
data.groupbyage <- trenal.long.noNA %>%   group_by(age) %>% summarise(avgHc=mean(Hc))
ggplot(data=data.groupbyage,aes(y=avgHc,x=age))+geom_point()
```

## Conclusions after exploring data analysis

-   The Hc time trend tends to increase first from 0 to 0.5 year then
    keep variated during the rest of the meassurements
-   The subject related variables age may increase the mean Hc level of
    a subject
-   Male has relative higher Hc level than female
-   Cardio or reject play no big difference in the Hc level
    measurements.

# Data analysis

## Multivariate Data Analysis using `lm`

```{r,echo=TRUE}
lm0 <- lm(Hc ~ time, trenal.long)
lm1 <- lm(Hc ~ time + age, trenal.long)
lm2 <- lm(Hc ~ time + age + male,trenal.long)
lm3 <- lm(Hc ~ time + age + male + reject,trenal.long)
lm4 <- lm(Hc ~ time + age + male + reject + cardio,trenal.long)
anova(lm1,lm2,lm3,lm4)
```

## Two stage analysis

Obtaining beta's for the intercept and the time variable

```{r}

trenal.long.NA <- na.omit(trenal.long)

trenal_grouped<-groupedData(Hc~time|id,trenal.long.NA, inner = ~ male, labels=list(y="level of Haematocrit"),units=list(y="level of Haematocrit "))

modlist1 <- lmList (Hc ~ time|id, trenal_grouped , na.action = na.pass)

```

```{r}

beta0<- coef(modlist1)[,1]

beta1<- coef(modlist1)[,2]

bbdd<-data.frame(id=as.numeric(attributes(modlist1)$names),
                 beta0=coef(modlist1)[,1],beta1=coef(modlist1)[,2])
bbdd <- merge(trenal.long, bbdd[,c("id","beta0", "beta1")], by.x = "id", all.x = T)

bbdd <- bbdd[order(bbdd[,1]),]

bbdd <- bbdd %>%
  mutate(groups_age = case_when(age < 25 ~ "Young",
                           age >= 25 & age < 60 ~ "Adult",
                           age >= 60 ~ "Old"))


```

#### BETAS ANALYSIS

```{r}

ggplot(bbdd, aes(x=beta0, y=beta1)) + geom_point() + ggtitle("Beta comparison")

```

```{r}

(meanbeta0bymale<-tapply(bbdd$beta0,as.factor(bbdd$male),mean,na.rm=T))
(meanbeta1bymale<-tapply(bbdd$beta1,as.factor(bbdd$male),mean,na.rm=T))

```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=male)) +
geom_point()+
  geom_smooth(method='lm', formula= y~x)+
ggtitle("Beta comparison by Gender")

```

It seems that for gender classification, the intercept is higher for
male and also the slope.

```{r}
(meanbeta0byreject<-tapply(bbdd$beta0,as.factor(bbdd$reject),mean,na.rm=T))
(meanbeta1byreject<-tapply(bbdd$beta1,as.factor(bbdd$reject),mean,na.rm=T))
```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=reject)) + geom_point()+
  geom_smooth(method='lm', formula= y~x)+
ggtitle("Beta comparison by Rejection Level")

```

It seems that for rejection level classification, the intercept is
higher for people without experiencing a cardio-vascular problem during
the years preceding the transplantation. However, in this case the slope
is higher to its opposite group.

```{r}

(meanbeta0bycardio<-tapply(bbdd$beta0,as.factor(bbdd$cardio),mean,na.rm=T))
(meanbeta1bycardio<-tapply(bbdd$beta1,as.factor(bbdd$cardio),mean,na.rm=T))

```

```{r}
ggplot(bbdd, aes(x=beta0, y=beta1, color=cardio)) + geom_point()+
  geom_smooth(method='lm', formula= y~x)+
ggtitle("Beta comparison by Cardio Level")

```

It seems that for gender classification, the intercept and the slope is
higher for patient who did show symptoms of graft rejection during the
first three months after the transplantation

```{r}
(meanbeta0byage<-tapply(bbdd$beta0,as.factor(bbdd$groups_age),mean,na.rm=T))
(meanbeta1byage<-tapply(bbdd$beta1,as.factor(bbdd$groups_age),mean,na.rm=T))
```


```{r}

ggplot(bbdd, aes(x=beta0, y=beta1, color=groups_age)) + geom_point()+
  geom_smooth(method='lm', formula= y~x)+
ggtitle("Beta comparison by Age Group")

```

#### 2nd step

Fit the model and confidence interval. We will use the structure found
in the multivariate section.

##### Beta0

```{r}

modbeta0<-lm(beta0~male + cardio + age,bbdd)
summary(modbeta0)
confint(modbeta0)

```

$$\textsf{$\beta$}_0 = 33.75 + 2.1089 * Male- 0.11 * Cardio + 0.04 * Age + \epsilon_i$$

-   The intercept is 33.75.
-   If a subject is a male, the $\beta_{0}$ increases in 2.11 units.
-   If a subject increases the age, the $\beta_{0}$ increases in 0.04
    units.

##### Beta1

```{r}

### Fit a model for the slope

modbeta1<-lm(beta1~male + cardio + age,bbdd)
summary(modbeta1)
confint(modbeta1)

```

$$\textsf{$\beta$}_1 = 0.075 + 0.1721 * Male + 0.274 * Cardio + 0.01 * Age + \epsilon_i$$ -
The intercept is 0.075.

\- If a subject is a male, the $\beta_{1}$ increases in 0.0274 units.

\- If a subject increases the age, the $\beta_{1}$ increases in 0.01
units.

## Linear Mixed Effects Model Analysis using `lmer`

### Conduct the analysis level by level 

::: footer
inspired by Chapter 8 and 9 of
<https://bookdown.org/roback/bookdown-BeyondMLR/ch-lon.html>
:::

    Level One : time and the response variable e.g. Hc level 
    Level Two : covariates related to each subject, e.g. age, male, reject, cardio

The trials related to Level One (only time as covariate)

```{r,echo=TRUE}
model.a <- lmer(Hc ~ 1 + (1|id),REML=T,data=trenal.long)
model.b <- lmer(Hc ~ time + (time|id),REML=T,data= trenal.long)
model.c <- lmer(Hc ~ timec + I(timec^2) + (timec + I(timec^2)|id),REML=T, data=trenal.long.center)
model.b.piecewise <- lmer(Hc ~ time1 + time2 + (time2|id),REML=T,data=trenal.long.piecewise)
```

The trials related to level Two (Add subject related variable)

## Unconditional Means Model{.smaller} 
### --- to discover variance distribution
We can first try the unconditional Means Model to explore the variance( within subject and between-subject), Define $Y_{ij}$ as the Hc level from subject $i$ and measured time $j$

    Level One: 
  $$Y_{ij} = a_i + \epsilon_{ij},$$ where $\epsilon_{ij} \sim N(0,\sigma^2)$
    Level Two: 
  $$a_i = \alpha_0 + u_i,$$ where $u_i \sim N(0,\sigma_{u}^2)$
  
Written in linear mixed effect model is:
  $$Y_{ij} = \alpha_0 + u_i + \epsilon_{ij},$$ where $u_i \sim N(0,\sigma_u^2)$ and $\epsilon_{ij} \sim N(0,\sigma^2)$
```{r}
summary(model.a)
```

From the output of `model.a`, we obtain estimates of three model
parameters:

-   $\hat{\alpha}_0 = 38.16$: the mean of Hc level $\mu_{Hc}$ across all
    subjects and all years
-   $\hat{\sigma}^2 = 23.07$: the variance in within-subjects deviation,
    between years of measurements $Hc_j$ and the mean $\mu_{Hc}$ across
    all subjects and all years
-   $\hat{\sigma_u}^2 = 13.60$: the variance in between-subjects
    deviation, between subject mean $\mu_{Hc_i}$ and the overall mean
    $\mu_{Hc}$ across all subjects and all years.

The intraclass correlation coefficient:
$$\hat{\rho}= \frac{\hat{\sigma_u}^2}{\hat{\sigma_u}^2+\hat{\sigma}^2} = \frac{13.60}{13.60+ 23.07}=0.371$$

## Unconditional Growth Model{.smaller}
### --- introducing time in Level One

    Level One: 
  $$Y_{ij} = a_i + b_i \times time_{ij} + \epsilon_{ij},$$ where $\epsilon_{ij} \sim N(0,\sigma^2)$
  
    Level Two: 
  \begin{align}
     a_i &= \alpha_0 + u_i, \\
     b_i &= \beta_0 + v_i
     \end{align}
  where $\begin{bmatrix} u_i \\ v_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v \\ \rho_{uv} \sigma_u\sigma_v & \sigma_v^2 \end{bmatrix}\right)$


Written in linear mixed effect model is:
$$Y_{ij} = [\alpha_0 + \beta_0 \times time_{ij}] + [ u_i + v_i \times time_{ij} +  \epsilon_{ij} ],$$
where
$\begin{bmatrix} u_i \\ v_i \end{bmatrix} \sim N\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v \\ \rho_{uv} \sigma_u\sigma_v & \sigma_v^2 \end{bmatrix}\right)$
and $\epsilon_{ij} \sim N(0,\sigma^2)$

```{r}
# model b
summary(model.b)
```

From the `model.b`, we obtain estimates of our six model parameters:

-   $\hat{\alpha}_0 = 37.2678$: the mean Hc level for the subjects at
    time 0, $Hc_0$
-   $\hat{\beta}_0 = 0.31583$: the mean change in successively
    measurements during totally $12$ measurements
-   $\hat{\sigma}^2 = 20.8883$: the variance in within-subject
    deviations
-   $\hat{\sigma}_u^2 = 13.5731$: the variance between subjects at time
    0, $Hc_0$
-   $\hat{\sigma}_v^2 = 0.1856$: the variance between subjects in rate
    of changes in Hc level
-   $\rho_{uv} = -0.15$: the correlation in subject's $Hc_0$ and the
    rate of change in Hc level

The estimated within-subject variance $\hat{\sigma}^2$ decreased by
about $9\%$ from the unconditional means model implying that $9\%$ of
within-subject variability in Hc level can be explained by a linear
increase over time:
$$Pseudo R^2_{L1} = \frac{\hat{\sigma}^2(uncond. means)-\hat{\sigma}^2(uncond. growth)}{\hat{\sigma}^2(uncond. growth)} = \frac{23.07-20.8883}{23.07} = 0.0948$$

## Quadratic time trend modeling{.smaller}

    Level One: 
  $$Y_{ij} = a_i + b_i \times time_{ij} + c_i \times time_{ij}^2 + \epsilon_{ij},$$ where $\epsilon_{ij} \sim N(0,\sigma^2)$
  
    Level Two: 
  \begin{align}
     a_i &= \alpha_0 + u_i, \\
     b_i &= \beta_0 + v_i, \\
     c_i &= \gamma_0 + w_i,
     \end{align}
  where $\begin{bmatrix} u_i \\ v_i \\w_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \\0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v & \rho_{uw} \sigma_u \sigma_w \\ &  \sigma_v^2 & \rho_{vw} \sigma_v\sigma_w \\ & & \sigma_w^2 \end{bmatrix}\right)$

Written in linear mixed effect model is:
$$Y_{ij} = [\alpha_0 + \beta_0 \times time_{ij} + \gamma_0 \times time_{ij}^2] + [ u_i + v_i \times time_{ij} + w_i \times time_{ij}^2 +  \epsilon_{ij} ],$$ where  $\begin{bmatrix} u_i \\ v_i \\w_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \\0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v & \rho_{uw} \sigma_u \sigma_w \\ &  \sigma_v^2 & \rho_{vw} \sigma_v\sigma_w \\ & & \sigma_w^2 \end{bmatrix}\right)$ and $\epsilon_{ij} \sim N(0,\sigma^2)$
```{r}
summary(model.c)
```



## Piecewise linear time trend{.smaller}

In the **piecewise linear model**, the complete time span of the study is divided into two segments, with a separate slope relating time to the response in each segment.

    Level One: 
  $$Y_{ij} = a_i + b_i \times time_{1_{ij}} + c_i \times time_{2_{ij}} + \epsilon_{ij},$$ where $\epsilon_{ij} \sim N(0,\sigma^2)$
  
  * Level Two: 
  
  \begin{align}
  a_i &= \alpha_0 + u_i, \\
  b_i &= \beta_0 + v_i, \\
  c_i &= \gamma_0 + w_i,
  \end{align}
  where $\begin{bmatrix} u_i \\ v_i \\w_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \\0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v & \rho_{uw} \sigma_u \sigma_w \\ &  \sigma_v^2 & \rho_{vw} \sigma_v\sigma_w \\ & & \sigma_w^2 \end{bmatrix}\right)$

Written in linear mixed effect model is:
$$Y_{ij} = [\alpha_0 + \beta_0 \times time_{1_{ij}} + \gamma_0 \times time_{2_{ij}}] + [ u_i + v_i \times time_{1_{ij}} + w_i \times time_{2_{ij}} +  \epsilon_{ij} ],$$
where
$\begin{bmatrix} u_i \\ v_i \\w_i \end{bmatrix} \sim N\left(\begin{bmatrix} 0 \\ 0 \\0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v & \rho_{uw} \sigma_u \sigma_w \\ & \sigma_v^2 & \rho_{vw} \sigma_v\sigma_w \\ & & \sigma_w^2 \end{bmatrix}\right)$
and $\epsilon_{ij} \sim N(0,\sigma^2)$

In our case study, we can fit separate slope in time $0-0.5$ and
$0.5-10$

```{r}
summary(model.b.piecewise)
```

## Comparing the level one models

Comparing the AIC/ BIC value
```{r,echo=TRUE,eval=FALSE}
model.a <- lmer(Hc ~ 1 + (1|id),REML=T,data=trenal.long)
model.b <- lmer(Hc ~ time + (time|id),REML=T,data= trenal.long)
model.c <- lmer(Hc ~ timec + I(timec^2) + (timec + I(timec^2)|id),REML=T, data=trenal.long.center)
model.b.piecewise <- lmer(Hc ~ time1 + time2 + (time2|id),REML=T,data=trenal.long.piecewise)
```

```{r}
cat("model.a: AIC = ",AIC(model.a),";BIC = ", BIC(model.a),"\n")
cat("model.b: AIC = ",AIC(model.b),";BIC = ", BIC(model.b),"\n")
cat("model.c: AIC = ",AIC(model.c),";BIC = ", BIC(model.c),"\n")
cat("model.b.piecewise: AIC = ",AIC(model.b.piecewise),";BIC = ", BIC(model.b.piecewise), "\n")
```
`model.c` has the lowest AIC BIC value. But we keep the linear time trend with piecewise time intervals, considering that in real case the Hc level (the percentage of red blood cells in the body) will be affected more by health status than the age of a person. 

Besides, the quadratic model seems not really identifiable


::: columns
::: {.column width="50%"}
```{r}
summary(model.c)
```
:::

::: {.column width="50%"}
```{r}
summary(model.b.piecewise)
```
:::
:::

## Adding subject related variable in level two
### Based on the `model.b`
```{r,echo=TRUE}
model.b.age <- lmer(Hc ~ time  + age + (time|id),REML=T,data=trenal.long.scaled)
model.b.male <- lmer(Hc ~ time + male + (time|id),REML=T,data=trenal.long.scaled)
model.b.agemale <- lmer(Hc ~ time  +male + age +(time|id),REML=T,data=trenal.long.scaled)
model.b.agemalereject <- lmer(Hc ~ time  +age + male+ reject +(time|id),REML=T,data=trenal.long.scaled)
```

```{r,echo=FALSE}
cat("model.b: AIC = ",AIC(model.b),";BIC = ", BIC(model.b), "\n")
cat("model.b.age: AIC = ",AIC(model.b.age),";BIC = ", BIC(model.b.age), "\n")
cat("model.b.male: AIC = ",AIC(model.b.male),";BIC = ", BIC(model.b.male), "\n")
cat("model.b.agemale: AIC = ",AIC(model.b.agemale),";BIC = ", BIC(model.b.agemale), "\n")
cat("model.b.agemalereject: AIC = ",AIC(model.b.agemalereject),";BIC = ", BIC(model.b.agemalereject), "\n")
```

## Final chosen model
Our chosen model would be the linear model with age gender as the level two variables `model.b.agemale`.
```{r}
summary(model.b.agemale)
```



## Adding subject related variable in level two
### Based on the `model.b.piecewise`

```{r,echo=TRUE}
model.b.piecewise.age <- lmer(Hc ~ time1 + time2 + age + (time2|id),REML=T,data=trenal.long.piecewise)
model.b.piecewise.male <- lmer(Hc ~ time1 + time2 + male + (time2|id),REML=T,data=trenal.long.piecewise)
model.b.piecewise.agemale <- lmer(Hc ~ time1 + time2  +male + age +(time2|id),REML=T,data=trenal.long.piecewise)
model.b.piecewise.agemalereject <- lmer(Hc ~ time1 + time2  +age + male+ reject +(time2|id),REML=T,data=trenal.long.piecewise)
```

```{r,echo=FALSE}
cat("model.b.piecewise: AIC = ",AIC(model.b.piecewise),";BIC = ", BIC(model.b.piecewise), "\n")
cat("model.b.piecewise.age: AIC = ",AIC(model.b.piecewise.age),";BIC = ", BIC(model.b.piecewise.age), "\n")
cat("model.b.piecewise.male: AIC = ",AIC(model.b.piecewise.male),";BIC = ", BIC(model.b.piecewise.male), "\n")
cat("model.b.piecewise.agemale: AIC = ",AIC(model.b.piecewise.agemale),";BIC = ", BIC(model.b.piecewise.agemale), "\n")
cat("model.b.piecewise.agemalereject: AIC = ",AIC(model.b.piecewise.agemalereject),";BIC = ", BIC(model.b.piecewise.agemalereject), "\n")
```

## Final chosen model

```{r}
summary(model.b.piecewise.agemale)
```

$$Y_{ij} = [32.69 + 4.112\times time_{1_{ij}} +0.4066 \times time_{2_{ij}} + 2.347 \times male_i + 0.058747 \times age_i] + [u_i + v_i \times time_{2_{ij}}+ \epsilon_{ij} $$
 where  $\begin{bmatrix} u_i \\ v_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix}12.038 & -0.3155271 \\ -0.3155271 & 0.1874\end{bmatrix}\right)$,and $\epsilon_{ij} \sim N(0,20.47)$
 
# Two Stage Model Analysis comparison

## Two stage Model 
### Stage one
```{r}
trenal.grouped<-groupedData(Hc~time|id,trenal.long, inner = ~ male+cardio+reject, labels=list(y="level of Haematocrit"),units=list(y="%"))
modlist1 <- lmList (Hc ~ time|id, trenal.grouped , na.action = na.pass)
a = coef(modlist1)[,1]
b = coef(modlist1)[,2]
plot.new()
par(mfrow=c(1,2))
hist(a,xlab="intercepts",ylab="Frequency",title="Histogram for intercepts")
hist(b,xlab="slopes for t",ylab="Frequency",title="Histogram for time slopes")
```
### Stage two

```{r}
# appendix the value of a, b, c to the original data frame
ab <- data.frame(id=as.numeric(attributes(modlist1)$names),
                 a=coef(modlist1)[,1],b=coef(modlist1)[,2])
ab <- merge(trenal.long, ab[,c("id","a", "b")], by.x = "id", all.x = T)
ab <- ab[order(ab[,1]),]
head(ab)
```
```{r}
### Fit a model for the intercept
fita<-lm(a ~ age + male,ab)
summary(fita)
confint(fita)

### Fit a model for the slope t

fitb<-lm(b ~ age + male ,ab)
summary(fitb)
confint(fitb)

```

## The equivalent LMM model should be

    Level One: 
  $$Y_{ij} = a_i + b_i \times time_{ij} + \epsilon_{ij},$$ where $\epsilon_{ij} \sim N(0,\sigma^2)$
  
    Level Two: 
  \begin{align}
     a_i &= \alpha_0 + \alpha_1 \times age_i + \alpha_2 \times male_i +  u_i, \\
     b_i &= \beta_0 + \beta_1 \times age_i + \beta_2 \times male_i + v_i
     \end{align}
  where $\begin{bmatrix} u_i \\ v_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v \\ \rho_{uv} \sigma_u\sigma_v & \sigma_v^2 \end{bmatrix}\right)$


The equivalent linear mixed effect model is:
 $$Y_{ij} = [\alpha_0 + \alpha_1 \times age_i +  \alpha_2 \times male_i + \beta_0 \times time_{ij} +\beta_1 \times age_i \times time_{ij} +\beta_2 \times male_i \times time_{ij} ] + [ u_i + v_i \times time_{ij} +  \epsilon_{ij} ],$$

 
 where $\begin{bmatrix} u_i \\ v_i \end{bmatrix} \sim  N\left(\begin{bmatrix} 0 \\ 0 \end{bmatrix}, \begin{bmatrix}\sigma_{u}^2 & \rho_{uv}\sigma_u\sigma_v \\ \rho_{uv} \sigma_u\sigma_v & \sigma_v^2 \end{bmatrix}\right)$ and $\epsilon_{ij} \sim N(0,\sigma^2)$
```{r}
model.b.equivalent <- lmer(Hc ~ age + male + time+ age:time+male:time+(time|id),REML=T,data=trenal.long)
t = fixef(model.b.equivalent)
```

## Result comparison


```{r}
coeff.twostage = c(extract_numeric(fita$coefficients), extract_numeric(fitb$coefficients))
fixeff = fixed.effects(model.b.equivalent)
coeff.LMM = extract_numeric(fixeff)
coefficients.name = c('alpha_0','alpha_1','alpha_2','beta_0','beta_1','beta_2')

coefficients.comparison= cbind(coefficients.name,coeff.twostage,coeff.LMM)
knitr::kable(coefficients.comparison)
```